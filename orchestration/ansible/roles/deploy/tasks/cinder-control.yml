---
- name: Create Cinder API service
  command: "helm install ../../helm/microservice/cinder-api-svc --namespace kolla --name cinder-api-svc --values /etc/kolla/cloud.yaml"

- name: Start Cinder create db job
  command: "helm install ../../helm/microservice/cinder-create-db-job --namespace kolla --name cinder-create-db-job --values /etc/kolla/cloud.yaml"

- name: Start Cinder manage db job
  command: "helm install ../../helm/microservice/cinder-manage-db-job --namespace kolla --name cinder-manage-db-job --values /etc/kolla/cloud.yaml"

- name: Start Cinder create keystone service job
  command: "helm install ../../helm/microservice/cinder-create-keystone-service-job --namespace kolla --name cinder-create-keystone-service-job --values /etc/kolla/cloud.yaml"

- name: Start Cinder create keystone service v2 job
  command: "helm install ../../helm/microservice/cinder-create-keystone-servicev2-job --namespace kolla --name cinder-create-keystone-servicev2-job --values /etc/kolla/cloud.yaml"

- name: Start Cinder create keystone user job
  command: "helm install ../../helm/microservice/cinder-create-keystone-user-job --namespace kolla --name cinder-create-keystone-user-job --values /etc/kolla/cloud.yaml"

- name: Start Cinder create keystone endpoint public job
  command: "helm install ../../helm/microservice/cinder-create-keystone-endpoint-public-job --namespace kolla --name cinder-create-keystone-endpoint-public-job --values /etc/kolla/cloud.yaml"

- name: Start Cinder create keystone endpoint internal job
  command: "helm install ../../helm/microservice/cinder-create-keystone-endpoint-internal-job --namespace kolla --name cinder-create-keystone-endpoint-internal-job --values /etc/kolla/cloud.yaml"

- name: Start Cinder create keystone endpoint admin job
  command: "helm install ../../helm/microservice/cinder-create-keystone-endpoint-admin-job --namespace kolla --name cinder-create-keystone-endpoint-admin-job --values /etc/kolla/cloud.yaml"

- name: Start Cinder create keystone endpoint public v2 job
  command: "helm install ../../helm/microservice/cinder-create-keystone-endpoint-publicv2-job --namespace kolla --name cinder-create-keystone-endpoint-publicv2-job --values /etc/kolla/cloud.yaml"

- name: Start Cinder create keystone endpoint internal v2 job
  command: "helm install ../../helm/microservice/cinder-create-keystone-endpoint-internalv2-job --namespace kolla --name cinder-create-keystone-endpoint-internalv2-job --values /etc/kolla/cloud.yaml"

- name: Start Cinder create keystone endpoint admin v2 job
  command: "helm install ../../helm/microservice/cinder-create-keystone-endpoint-adminv2-job --namespace kolla --name cinder-create-keystone-endpoint-adminv2-job --values /etc/kolla/cloud.yaml"

- name: Wait for Cinder jobs
  command: "python ../../tools/wait_for_pods.py kolla cinder-create-db,cinder-manage-db,cinder-create-keystone-service,cinder-create-keystone-servicev2,cinder-create-keystone-user,cinder-create-keystone-endpoint-public,cinder-create-keystone-endpoint-internal,cinder-create-keystone-endpoint-admin,cinder-create-keystone-endpoint-publicv2,cinder-create-keystone-endpoint-internalv2,cinder-create-keystone-endpoint-adminv2 completed,succeeded"

- name: Cleanup Cinder jobs
  command: "helm delete --purge {{item}}"
  with_items:
    - cinder-create-db-job
    - cinder-manage-db-job
    - cinder-create-keystone-service-job
    - cinder-create-keystone-servicev2-job
    - cinder-create-keystone-user-job
    - cinder-create-keystone-endpoint-public-job
    - cinder-create-keystone-endpoint-internal-job
    - cinder-create-keystone-endpoint-admin-job
    - cinder-create-keystone-endpoint-publicv2-job
    - cinder-create-keystone-endpoint-internalv2-job
    - cinder-create-keystone-endpoint-adminv2-job

- name: Start Cinder API deployment
  command: "helm install ../../helm/microservice/cinder-api-deployment --namespace kolla --name cinder-api-deployment --values /etc/kolla/cloud.yaml"

- name: Start Cinder Scheduler
  command: "helm install ../../helm/microservice/cinder-scheduler-statefulset --namespace kolla --name cinder-scheduler-statefulset --values /etc/kolla/cloud.yaml"

- name: Wait for cinder to start running
  command: "python ../../tools/wait_for_pods.py kolla cinder running,succeeded"
