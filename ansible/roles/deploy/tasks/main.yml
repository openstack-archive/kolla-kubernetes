---
- include: "mariadb.yml"

- name: Wait for mariadb to start running
  command: "python ../tools/wait_for_pods.py kolla mariadb running,succeeded"

- name: Get database password
  shell: kubectl -n kolla get secret database-password -ojsonpath={.data.password} | base64 --decode
  register: db_password

- name: Check mariadb running
  command: "kubectl -n kolla exec mariadb-0 -- mysqladmin -u {{database_user}} -p{{db_password.stdout}} status"
  register: mariadb_status
  retries: 12
  delay: 5
  until: mariadb_status.rc == 0

- include: "rabbitmq.yml"

- name: Wait for rabbitmq to start running
  command: "python ../tools/wait_for_pods.py kolla rabbitmq running,succeeded"

- name: Check rabbitmq running
  command: "kubectl -n kolla exec rabbitmq-0 -- rabbitmqctl status"
  register: rabbitmq_status
  retries: 12
  delay: 5
  until: rabbitmq_status.rc == 0

- include: "memcached.yml"
- include: "keystone.yml"
#- include: "glance.yml"
#- include: "cinder-control.yml"
#- include: "horizon.yml"
#- include: "openvswitch.yml"
#- include: "neutron.yml"

#- name: Wait until running
  #command: "python ../tools/wait_for_pods.py kolla rabbitmq,memcached,keystone running,succeeded"

#- include: "cleanup.yml"
