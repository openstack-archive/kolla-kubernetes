---

# Kolla-Kubernetes Configuration

# Note: Ansible remote-src copy does not recurse dirs, hence using cp
- name: Copy default kolla configuration to etc
  become: True
  command: cp -aR /home/{{ username }}/kolla-ansible/etc/kolla /etc

- name: Copy default kolla-kubernetes configuration to /etc
  become: True
  command: cp -aR /home/{{ username }}/kolla-kubernetes/etc/kolla-kubernetes /etc

- name: Generate default passwords via SPRNG
  command: kolla-kubernetes-genpwd

- name: Create a kubernetes namespace to isolate this kolla deployment
  command: kubectl create namespace kolla
  ignore_errors: True

- name: Label the master node as the controller node
  command: kubectl label node {{ ansible_hostname }} kolla_controller=true
  ignore_errors: True

- name: Label the master node a compute node
  command: kubectl label node {{ ansible_hostname }} kolla_compute=true
  ignore_errors: True
  when:
    - master_works == True

# TODO Remove after worker label below is solved
#- name: Log Hostvars
#  debug: msg="{{ hostvars }}"

# TODO Fix this: Get list of nodes and label them compute
#- name: Label the worker node a compute node
#  command: kubectl label node "{{ item }}" kolla_compute=true
#  with_items: groups.kube-workers
#  ignore_errors: True

- set_fact:
      globals_config: "{{ lookup('template', 'templates/globals_config.j2') }}"

- name: Add required configuration to the end of /etc/kolla/globals.yml
  blockinfile:
    dest: /etc/kolla/globals.yml
    content: '{{ globals_config }}'
    state: present
    insertafter: EOF

- name: Set network_interface in globals.yaml
  lineinfile:
    dest: /etc/kolla/globals.yml
    line: "network_interface: {{ management_iface }}"
    regexp: "^(.*)network_interface:(.*)$"
  become: True

- name: Set neutron_external_interface in globals.yaml
  lineinfile:
    dest: /etc/kolla/globals.yml
    line: "neutron_external_interface: {{ neutron_iface }}"
    regexp: "^(.*)neutron_external_interface:(.*)$"
  become: True

- file:
    path: /etc/kolla/config/
    state: directory
    mode: 0755

- name: Enable QEMU libvirt functionality and enable a workaround for a bug in libvirt
  blockinfile:
    dest: /etc/kolla/config/nova.conf
    state: present
    create: yes
    content: |
      [libvirt]
      virt_type=qemu
      cpu_mode=none
  become: True

- name: Generate the default configuration
  command: sudo ansible-playbook -e ansible_python_interpreter=/usr/bin/python -e @/etc/kolla/globals.yml -e @/etc/kolla/passwords.yml -e CONFIG_DIR=/etc/kolla kolla-kubernetes/ansible/site.yml

# TODO remove ignore errors
- name: Generate the Kubernetes secrets and register them with Kubernetes
  command: /home/{{ username }}/kolla-kubernetes/tools/secret-generator.py create
  ignore_errors: True

# TODO remove ignore errors currently needed for re-running task
- name: Enable resolv.conf workaround
  command: /home/{{ username }}/kolla-kubernetes/tools/setup-resolv-conf.sh kolla
  ignore_errors: True
