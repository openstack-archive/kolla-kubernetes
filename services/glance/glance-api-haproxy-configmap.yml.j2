apiVersion: v1
kind: ConfigMap
metadata:
  name: glance-api-haproxy
data:
  haproxy.conf: |
    global
      chroot /var/lib/haproxy
      user haproxy
      group haproxy
      daemon
      log /var/lib/kolla/heka/log local0
      maxconn 4000
      stats socket /var/lib/kolla/haproxy/haproxy.sock
    
    defaults
      log global
      mode http
      option redispatch
      option httplog
      option forwardfor
      retries 3
      timeout http-request 10s
      timeout queue 1m
      timeout connect 10s
      timeout client 1m
      timeout server 1m
      timeout check 10s

    listen glance_api
#FIXME need to ensure we have a glance_api_port_internal vs external
      bind 0.0.0.0:{{ glance_api_port }}
      server local-api 127.0.0.1:{{ glance_api_port }} check inter 2000 rise 2 fall 5

  config.json: |
    {
        "command": "/usr/sbin/haproxy-systemd-wrapper -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid",
        "config_files": [{
    	    "source": "/var/lib/kolla/config_files/haproxy.cfg",
    	    "dest": "/etc/haproxy/haproxy.cfg",
    	    "owner": "root",
    	    "perm": "0644"
    	}]
    }
 
