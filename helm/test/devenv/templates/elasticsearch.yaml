apiVersion: v1
data:
  config.json: |-
    {
        "config_files": [
            {
                "dest": "/etc/elasticsearch/elasticsearch.yml",
                "source": "/var/lib/kolla/config_files/elasticsearch.yml",
                "perm": "0600",
                "owner": "elasticsearch"
            },
        ],
        "command": "/usr/share/elasticsearch/bin/elasticsearch",
        "permissions": [
            {
                "owner": "elasticsearch:elasticsearch",
                "path": "/var/lib/elasticsearch",
                "recurse": true
            },
            {
                "owner": "elasticsearch:elasticsearch",
                "path": "/var/log/kolla/elasticsearch",
                "recurse": true
            }
        ]
    }
  elasticsearch.yml: |+
    driver = noop
    {% set num_nodes = groups['elasticsearch'] | length %}
    {% set minimum_master_nodes = (num_nodes / 2 + 1) | round(0, 'floor') | int if num_nodes > 2 else 1 %}
    {% set recover_after_nodes = (num_nodes * 2 / 3) | round(0, 'floor') | int if num_nodes > 1 else 1 %}
    node.name: "0.0.0.0"
    network.host: {_eth0:ipv4_}

    cluster.name: "0.0.0.0"
    node.master: true
    node.data: true
    discovery.zen.ping.unicast.hosts: ["0.0.0.0"]

   discovery.zen.minimum_master_nodes: {{ minimum_master_nodes }}
   gateway.expected_nodes: {{ num_nodes }}
   gateway.recover_after_time: "5m"
   gateway.recover_after_nodes: {{ recover_after_nodes }}
   path.conf: "/etc/elasticsearch"
   path.data: "/var/lib/elasticsearch/data"
   path.logs: "/var/log/kolla/elasticsearch"
   path.scripts: "/etc/elasticsearch/scripts"

kind: ConfigMap
metadata:
  name: elasticsearch
