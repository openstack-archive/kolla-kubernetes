# Requires .valName and env (.Values, .elementName, .serviceName, .ServiceKind)
# Optional env (.serviceType)
{{- define "kolla_val_get" }}
{{- if hasKey .env "serviceType" }}
{{- include "kolla_val_get_2lvl" . }}
{{- else }}
{{- include "kolla_val_get_simple" . }}
{{- end }}
{{- end }}

{{- define "kolla_val_get_simple" }}
{{- $elementNameValues := index .env.Values.global.kolla .env.elementName | default dict }}
{{- $elementKindValues := index $elementNameValues .env.serviceKind | default dict }}
{{- $elementAllValues := index $elementNameValues "all" | default dict }}
{{- $serviceNameValues := index .env.Values.global.kolla .env.serviceName | default dict }}
{{- $serviceKindValues := index $serviceNameValues .env.serviceKind | default dict }}
{{- $serviceAllValues := index $serviceNameValues "all" | default dict }}
{{- $localVals := dict "val" "" }}
{{- if and (hasKey .env.Values.global.kolla.all .valName) (ne (typeOf (index .env.Values.global.kolla.all .valName)) "<nil>") }}{{- $_ := set $localVals "val" (index .env.Values.global.kolla.all .valName) }}{{- end }}
{{- if and (hasKey $serviceAllValues .valName) (ne (typeOf (index $serviceAllValues .valName)) "<nil>") }}{{- $_ := set $localVals "val" (index $serviceAllValues .valName) }}{{- end }}
{{- if and (hasKey $serviceKindValues .valName) (ne (typeOf (index $serviceKindValues .valName)) "<nil>") }}{{- $_ := set $localVals "val" (index $serviceKindValues .valName) }}{{- end }}
{{- if and (hasKey $elementAllValues .valName) (ne (typeOf (index $elementAllValues .valName)) "<nil>") }}{{- $_ := set $localVals "val" (index $elementAllValues .valName) }}{{- end }}
{{- if and (hasKey $elementKindValues .valName) (ne (typeOf (index $elementKindValues .valName)) "<nil>") }}{{- $_ := set $localVals "val" (index $elementKindValues .valName) }}{{- end }}
{{- if and (hasKey .env.Values .valName) (ne (typeOf (index .env.Values .valName)) "<nil>") }}{{- $_ := set $localVals "val" (index .env.Values .valName) }}{{- end }}
{{- $localVals.val }}
{{- end }}

{{- define "kolla_val_get_2lvl" }}
{{- $serviceNameValues := index .env.Values.global.kolla .env.serviceName | default dict }}
{{- $serviceAllValues := index $serviceNameValues "all" | default dict }}
{{- $serviceTypeValues := index $serviceNameValues .env.serviceType | default dict }}
{{- $serviceTypeAllValues := index $serviceTypeValues "all" | default dict }}
{{- $serviceTypeKindValues := index $serviceTypeValues .env.serviceKind | default dict }}
{{- $localVals := dict "val" "" }}
{{- if and (hasKey .env.Values.global.kolla.all .valName) (ne (typeOf (index .env.Values.global.kolla.all .valName)) "<nil>") }}{{- $_ := set $localVals "val" (index .env.Values.global.kolla.all .valName) }}{{- end }}
{{- if and (hasKey $serviceAllValues .valName) (ne (typeOf (index $serviceAllValues .valName)) "<nil>") }}{{- $_ := set $localVals "val" (index $serviceAllValues .valName) }}{{- end }}
{{- if and (hasKey $serviceTypeAllValues .valName) (ne (typeOf (index $serviceTypeAllValues .valName)) "<nil>") }}{{- $_ := set $localVals "val" (index $serviceTypeAllValues .valName) }}{{- end }}
{{- if and (hasKey $serviceTypeKindValues .valName) (ne (typeOf (index $serviceTypeKindValues .valName)) "<nil>") }}{{- $_ := set $localVals "val" (index $serviceTypeKindValues .valName) }}{{- end }}
{{- if and (hasKey .env.Values .valName) (ne (typeOf (index .env.Values .valName)) "<nil>") }}{{- $_ := set $localVals "val" (index .env.Values .valName) }}{{- end }}
{{- $localVals.val }}
{{- end }}

{{- define "kolla_image_built_prefix" }}
{{- $dockerRegistry := include "kolla_val_get" (dict "valName" "docker_registry" "env" . ) }}
{{- $dockerNamespace := include "kolla_val_get" (dict "valName" "docker_namespace" "env" . ) }}
{{- $baseDistro := include "kolla_val_get" (dict "valName" "base_distro" "env" . ) }}
{{- $installType := include "kolla_val_get" (dict "valName" "install_type" "env" . ) }}
{{- printf "%s/%s/%s-%s" $dockerRegistry $dockerNamespace $baseDistro $installType }}
{{- end }}

# FIXME  rewrite all of these to use kolla_image_built_prefix. needs all templates to pass
# the deps for kolla_val_get
{{- define "kolla_toolbox_image_full" }}
{{- $kollaToolboxImageBuilt := printf "%s/%s/%s-%s-kolla-toolbox:%s" .Values.docker_registry .Values.docker_namespace .Values.kolla_base_distro .Values.kolla_install_type .Values.kolla_toolbox_image_tag }}
{{- $kollaToolboxImageFull := .Values.kolla_toolbox_image_full | default $kollaToolboxImageBuilt }}
{{- $kollaToolboxImageFull -}}
{{- end }}

{{- define "haproxy_image_full" }}
{{- $haproxyImageBuilt := printf "%s/%s/%s-%s-haproxy:%s" .Values.docker_registry .Values.docker_namespace .Values.kolla_base_distro .Values.kolla_install_type .Values.haproxy_image_tag }}
{{- $haproxyImageFull := .Values.haproxy_image_full | default $haproxyImageBuilt }}
{{- $haproxyImageFull -}}
{{- end }}

{{- define "fluentd_image_full" }}
{{- $fluentdImageBuilt := printf "%s/%s/%s-%s-fluentd:%s" .Values.docker_registry .Values.docker_namespace .Values.kolla_base_distro .Values.kolla_install_type .Values.fluentd_image_tag }}
{{- $fluentdImageFull := .Values.kolla_toolbox_image_full | default $fluentdImageBuilt }}
{{- $fluentdImageFull -}}
{{- end }}

{{- define "kubernetes_entrypoint_image_full" }}
{{- $kubernetesEntryPointImageBuilt := printf "%s/%s/%s-%s-kubernetes-entrypoint:%s" .Values.docker_registry .Values.docker_namespace .Values.kolla_base_distro .Values.kolla_install_type .Values.kubernetes_entrypoint_image_tag }}
{{- $kubernetesEntryPointImageFull := .Values.kubernetes_entrypoint_image_full | default $kubernetesEntryPointImageBuilt }}
{{- $kubernetesEntryPointImageFull }}
{{- end }}
