# YAML mapping of service->pods->containers
# This structure leaves room for adding configuration parameters.
# ORDER MATTERS: Kolla-Kubernetes will evaluate these list-item
#   resources in order.
# The (configmap) resources are not defined here, since they come
#   directly from kolla.
# The (disk, pv, pvc, and svc) resources hold volume or network state,
#   and are more dangerous to delete.  These resources are stateful.
#   Deleting a disk, pv, or pvc will lose data on a volume. Deleting
#   a svc will lose a load-balancer IP.
# The (bootstrap) resources should be run only once, to setup
#   persistent state.
# The (pod) resources may be destroyed willy-nilly, since they hold no
#   state.
# Template.vars are additional vars in the form of a dict passed to
#   the jinja templating engine. Templates may access this dict with
#   "kolla_kubernetes.template.vars.<subkey>".  This enables arguments
#   to be passed to templates so that they may be re-used or
#   configured.  These template.vars may not contain any other nested
#   jinja references, and are passed unmodified directly to the
#   template.

kolla-kubernetes:
  services:
  - name: ceph
    pods:
    resources:
      secret:
      - name: ceph
        template: services/ceph/ceph-secret.yml.j2
      disk:
      pv:
      pvc:
      svc:
      bootstrap:
      pod:
  - name: mariadb
    pods:
    - name: mariadb
      containers:
      - name: mariadb
    resources:
      secret:
      configmap:
      - name: mariadb
      disk:
      - name: mariadb
        template: services/common/common-disk.sh.j2
        vars:
          size_in_gb: 10
      pv:
      - name: mariadb
        template: services/common/common-pv.yml.j2
        vars:
          name: mariadb
          size_in_gb: 10
      pvc:
      - name: mariadb
        template: services/common/common-pvc.yml.j2
        vars:
          name: mariadb
          size_in_gb: 10
      svc:
      - name: mariadb
        template: services/mariadb/mariadb-service.yml.j2
      bootstrap:
      - name: mariadb-bootstrap
        template: services/mariadb/mariadb-bootstrap-job.yml.j2
        vars:
          pvc_name: mariadb
      pod:
      - name: mariadb
        template: services/mariadb/mariadb-pod.yml.j2
  - name: memcached
    pods:
    - name: memcached
      containers:
      - name: memcached
    resources:
      configmap:
      - name: memcached
      secret:
      disk:
      pv:
      pvc:
      svc:
      - name: memcached
        template: services/memcached/memcached-service.yml.j2
      bootstrap:
      pod:
      - name: memcached
        template: services/memcached/memcached-pod.yml.j2
  - name: keystone
    pods:
    - name: keystone
      containers:
      - name: keystone
    resources:
      configmap:
      - name: keystone
      secret:
      disk:
      pv:
      pvc:
      svc:
      - name: keystone-admin
        template: services/keystone/keystone-service-admin.yml.j2
      - name: keystone-public
        template: services/keystone/keystone-service-public.yml.j2
      bootstrap:
      - name: keystone-bootstrap
        template: services/keystone/keystone-bootstrap-job.yml.j2
      pod:
      - name: keystone
        template: services/keystone/keystone-pod.yml.j2
  - name: horizon
    pods:
    - name: horizon
      containers:
      - name: horizon
    resources:
      configmap:
      - name: horizon
      secret:
      disk:
      pv:
      pvc:
      svc:
      - name: horizon
        template: services/horizon/horizon-service.yml.j2
      bootstrap:
      pod:
      - name: horizon
        template: services/horizon/horizon-pod.yml.j2
  - name: rabbitmq
    pods:
    - name: rabbitmq
      containers:
      - name: rabbitmq
    resources:
      configmap:
      - name: rabbitmq
      secret:
      disk:
      - name: rabbitmq
        template: services/common/common-disk.sh.j2
        vars:
          size_in_gb: 10
      pv:
      - name: rabbitmq
        template: services/common/common-pv.yml.j2
        vars:
          name: rabbitmq
          size_in_gb: 10
      pvc:
      - name: rabbitmq
        template: services/common/common-pvc.yml.j2
        vars:
          name: rabbitmq
          size_in_gb: 10
      svc:
      - name: rabbitmq-management
        template: services/rabbitmq/rabbitmq-service-management.yml.j2
      - name: rabbitmq
        template: services/rabbitmq/rabbitmq-service.yml.j2
      bootstrap:
      - name: rabbitmq-bootstrap
        template: services/rabbitmq/rabbitmq-bootstrap-job.yml.j2
        vars:
          pvc_name: rabbitmq
      pod:
      - name: rabbitmq
        template: services/rabbitmq/rabbitmq-pod.yml.j2
  - name: glance
    pods:
    - name: glance
      containers:
      - name: glance-api
      - name: glance-registry
    resources:
      configmap:
      - name: glance-api
      - name: glance-registry
      - name: glance-api-haproxy
        template: services/common/api-haproxy-configmap.yml.j2
        vars:
          configmap_name: glance-api-haproxy
          port_name: glance_api_port
      - name: glance-registry-haproxy
        template: services/common/api-haproxy-configmap.yml.j2
        vars:
          configmap_name: glance-registry-haproxy
          port_name: glance_registry_port
      secret:
      disk:
      - name: glance
        template: services/common/common-disk.sh.j2
        vars:
          size_in_gb: 10
      pv:
      - name: glance
        template: services/common/common-pv.yml.j2
        vars:
          name: glance
          size_in_gb: 10
      pvc:
      - name: glance
        template: services/common/common-pvc.yml.j2
        vars:
          name: glance
          size_in_gb: 10
      svc:
      - name: glance-api
        template: services/common/generic-service.yml.j2
        vars:
          port_name: glance_api_port
          service: glance
          type: api
          name: glance-api
      - name: glance-registry
        template: services/common/generic-service.yml.j2
        vars:
          port_name: glance_registry_port
          service: glance
          type: registry
          name: glance-registry
      bootstrap:
      - name: glance-create-db
        template: services/glance/glance-bootstrap-job-create-db.yml.j2
      - name: glance-manage-db
        template: services/glance/glance-bootstrap-job-manage-db.yml.j2
        vars:
          pvc_name: glance
      - name: glance-endpoints
        template: services/glance/glance-bootstrap-job-endpoints.yml.j2
      pod:
      - name: glance-api
        template: services/glance/glance-api-pod.yml.j2
        vars:
          pvc_name: glance
      - name: glance-registry
        template: services/glance/glance-registry-pod.yml.j2
  - name: nova
    pods:
    - name: nova-compute
      containers:
      - name: nova-compute
      - name: nova-libvirt
    - name: nova-control
      containers:
      - name: nova-api
      - name: nova-scheduler
      - name: nova-conductor
      - name: nova-consoleauth
      - name: nova-novncproxy
    resources:
      configmap:
      - name: nova-api
      - name: nova-compute
      - name: nova-conductor
      - name: nova-scheduler
      - name: nova-consoleauth
      - name: nova-novncproxy
      - name: nova-novncproxy-haproxy
        template: services/common/api-haproxy-configmap.yml.j2
        vars:
          configmap_name: novnc-proxy-haproxy
          port_name: nova_novncproxy_port
      secret:
      disk:
      pv:
      pvc:
      svc:
      - name: nova-novncproxy
        template: services/common/generic-service.yml.j2
        vars:
          port_name: nova_novncproxy_port
          service: nova
          type: novncproxy
          name: nova-novncproxy
      - name: nova-api
        template: services/common/generic-service.yml.j2
        vars:
          port_name: nova_api_port
          service: nova
          type: api
          name: nova-api
      - name: nova-metadata
        template: services/common/generic-service.yml.j2
        vars:
          port_name: nova_metadata_port
          service: nova
          type: metadata
          name: nova-metadata
      bootstrap:
      - name: nova-compute-bootstrap
        template: services/nova/nova-compute-bootstrap-job.yml.j2
      - name: nova-create-api-db
        template: services/nova/nova-control-bootstrap-job-create-nova-api-db.yml.j2
      - name: nova-create-endpoints
        template: services/nova/nova-control-bootstrap-job-create-nova-endpoints.yml.j2
      - name: nova-create-db
        template: services/nova/nova-control-bootstrap-job-create-nova-db.yml.j2
      pod:
      - name: nova-compute
        template: services/nova/nova-compute-pod.yml.j2
      - name: nova-api
        template: services/nova/nova-control-api-pod.yml.j2
      - name: nova-conductor
        template: services/nova/nova-control-conductor-pod.yml.j2
      - name: nova-scheduler
        template: services/nova/nova-control-scheduler-pod.yml.j2
      - name: nova-consoleauth
        template: services/nova/nova-control-consoleauth-pod.yml.j2
      - name: nova-novncproxy
        template: services/nova/nova-control-novncproxy-pod.yml.j2
  - name: openvswitch
    pods:
    - name: openvswitch-ovsdb
      containers:
      - name: openvswitch-ovsdb
    - name: openvswitch-vswitchd
      containers:
      - name: openvswitch-vswitchd
    resources:
      configmap:
      - name: openvswitch-db-server
      - name: openvswitch-vswitchd
      secret:
      disk:
      pv:
      pvc:
      svc:
      bootstrap:
      pod:
      - name: openvswitch-ovsdb-compute
        template: services/openvswitch/openvswitch-ovsdb-daemonset.yml.j2
        vars:
          type: compute
      - name: openvswitch-ovsdb-network
        template: services/openvswitch/openvswitch-ovsdb-daemonset.yml.j2
        vars:
          type: network
      - name: openvswitch-vswitchd-compute
        template: services/openvswitch/openvswitch-vswitchd-daemonset.yml.j2
        vars:
          type: compute
      - name: openvswitch-vswitchd-network
        template: services/openvswitch/openvswitch-vswitchd-daemonset.yml.j2
        vars:
          type: network
  - name: neutron
    pods:
    - name: neutron-compute
      containers:
      - name: openvswitch-db-server
      - name: openvswitch-vswitchd
      - name: neutron-openvswitch-agent
      - name: neutron-linuxbridge-agent
    - name: neutron-network
      containers:
      - name: neutron-l3-agent
      - name: neutron-dhcp-agent
      - name: neutron-metadata-agent
    - name: neutron-server
      containers:
      - name: neutron-server
    resources:
      configmap:
      - name: neutron-server
      - name: neutron-dhcp-agent
      - name: neutron-l3-agent
      - name: neutron-metadata-agent
      - name: neutron-openvswitch-agent
      secret:
      disk:
      pv:
      pvc:
      svc:
      - name: neutron-server
        template: services/common/generic-service.yml.j2
        vars:
          port_name: neutron_server_port
          service: neutron
          type: server
          name: neutron-server
      bootstrap:
      - name: neutron-create-db
        template: services/neutron/neutron-bootstrap-job-create-db.yml.j2
      - name: neutron-manage-db
        template: services/neutron/neutron-bootstrap-job-manage-db.yml.j2
      - name: neutron-endpoints
        template: services/neutron/neutron-bootstrap-job-endpoints.yml.j2
      pod:
      - name: neutron-openvswitch-agent-compute
        template: services/neutron/neutron-openvswitch-agent-daemonset.yml.j2
        vars:
          type: compute
      - name: neutron-openvswitch-agent-network
        template: services/neutron/neutron-openvswitch-agent-daemonset.yml.j2
        vars:
          type: network
      - name: neutron-server
        template: services/neutron/neutron-server-pod.yml.j2
      - name: neutron-dhcp-agent
        template: services/neutron/neutron-dhcp-agent-daemonset.yml.j2
      - name: neutron-l3-agent-network
        template: services/neutron/neutron-l3-agent-daemonset.yml.j2
        vars:
          type: network
      - name: neutron-l3-agent-compute
        template: services/neutron/neutron-l3-agent-daemonset.yml.j2
        vars:
          type: compute
      - name: neutron-metadata-agent-network
        template: services/neutron/neutron-metadata-agent-daemonset.yml.j2
        vars:
          type: network
      - name: neutron-metadata-agent-compute
        template: services/neutron/neutron-metadata-agent-daemonset.yml.j2
        vars:
          type: compute
  - name: swift
    pods:
    - name: swift-account
      containers:
      - name: swift-rsyncd
      - name: swift-account-server
      - name: swift-account-auditor
      - name: swift-account-replicator
      - name: swift-account-reaper'
    - name: swift-container
      containers:
      - name: swift-rsyncd
      - name: swift-container-server
      - name: swift-container-auditor
      - name: swift-container-replicator
      - name: swift-container-updater
    - name: swift-object
      containers:
      - name: swift-rsyncd
      - name: swift-object-server
      - name: swift-object-auditor
      - name: swift-object-replicator
      - name: swift-object-updater
      - name: swift-object-expirer
    - name: swift-proxy
      containers:
      - name: swift-proxy-server
    resources:
      configmap:
      - name: swift-rsyncd
      - name: swift-account-server
      - name: swift-account-auditor
      - name: swift-account-replicator
      - name: swift-account-reaper
      - name: swift-rsyncd
      - name: swift-container-server
      - name: swift-container-auditor
      - name: swift-container-replicator
      - name: swift-container-updater
      - name: swift-rsyncd
      - name: swift-object-server
      - name: swift-object-auditor
      - name: swift-object-replicator
      - name: swift-object-updater
      - name: swift-object-expirer
      - name: swift-proxy-server
      secret:
      disk:
      pv:
      pvc:
      svc:
      - name: swift-account
        template: services/swift/swift-account-service.yml.j2
      - name: swift-container
        template: services/swift/swift-container-service.yml.j2
      - name: swift-object
        template: services/swift/swift-object-service.yml.j2
      - name: swift-proxy
        template: services/swift/swift-proxy-service.yml.j2
      - name: swift-rsyncd
        template: services/swift/swift-rsync-service.yml.j2
      bootstrap:
      pod:
      - name: swift-account
        template: services/swift/swift-account-pod.yml.j2
      - name: swift-container
        template: services/swift/swift-container-pod.yml.j2
      - name: swift-object
        template: services/swift/swift-object-pod.yml.j2
      - name: swift-proxy
        template: services/swift/swift-proxy-pod.yml.j2
  - name: kube-dns
    pods:
    - name: skydns
      containers:
      - name: etcd
      - name: kube2sky
      - name: skydns
      - name: healthz
    resources:
      secret:
      disk:
      pv:
      pvc:
      svc:
      - name: kube-dns
        template: services/skydns/skydns-service.yml.j2
      bootstrap:
      pod:
      - name: kube-dns-v11
        template: services/skydns/skydns-pod.yml.j2
  - name: iscsi
    pods:
    resources:
      configmap:
      - name: openvswitch-iscsid
      - name: openvswitch-tgtd
      secret:
      disk:
      pv:
      pvc:
      svc:
      bootstrap:
      pod:
      - name: iscsi-iscsid
        template: services/iscsi/iscsi-iscsid-daemonset.yml.j2
      - name: iscsi-tgtd
        template: services/iscsi/iscsi-tgtd-daemonset.yml.j2
  - name: cinder
    pods:
    - name: cinder
      containers:
      - name: cinder-api
      - name: cinder-scheduler
      - name: cinder-backup
      - name: cinder-volume
    resources:
      configmap:
      - name: cinder-api
      - name: cinder-backup
      - name: cinder-scheduler
      - name: cinder-volume
      - name: cinder-api-haproxy
        template: services/common/api-haproxy-configmap.yml.j2
        vars:
          configmap_name: cinder-api-haproxy
          port_name: cinder_api_port
      secret:
      disk:
      pv:
      pvc:
      svc:
      - name: cinder-api
        template: services/common/generic-service.yml.j2
        vars:
          port_name: cinder_api_port
          service: cinder
          type: api
          name: cinder-api
      bootstrap:
      - name: cinder-create-db
        template: services/cinder/cinder-bootstrap-job-create-db.yml.j2
      - name: cinder-manage-db
        template: services/cinder/cinder-bootstrap-job-manage-db.yml.j2
      - name: cinder-create-endpoints
        template: services/cinder/cinder-bootstrap-job-endpoints.yml.j2
      pod:
      - name: cinder-api
        template: services/cinder/cinder-api-pod.yml.j2
      - name: cinder-scheduler
        template: services/cinder/cinder-scheduler-pod.yml.j2
      - name: cinder-backup
        template: services/cinder/cinder-backup-pod.yml.j2
      - name: cinder-volume-lvm
        template: services/cinder/cinder-volume-lvm-pod.yml.j2
